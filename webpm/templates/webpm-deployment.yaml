apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpm
  labels:
    app: webpm
spec:
  replicas: 2

  selector:
    matchLabels:
      app: webpm

  template:

    metadata:
      name: webpm
      labels:
        app: webpm
    spec:
      imagePullSecrets:
        - name: gitlab-docker
      {{- if .Values.customLoggingConfig }}
      volumes:
        - name: logging-conf
          configMap:
            name: logging-conf
      {{- end }}
      containers:
        - name: main
          {{- if .Values.customLoggingConfig }}
          volumeMounts:
          - name: logging-conf
            mountPath: /app/logging.yaml
            subPath: logging.yaml
          {{- end }}
          securityContext:
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10000
            runAsGroup: 10000
          env:
            - name: ROOT_REDIRECTION
              valueFrom:
                configMapKeyRef:
                  key: root_redirection
                  name: webpm
            - name: CONFIG_ID
              valueFrom:
                configMapKeyRef:
                  key: configID
                  name: webpm
            - name: HOST
              valueFrom:
                configMapKeyRef:
                  key: host
                  name: webpm
            - name: OIDC_ISSUER
              valueFrom:
                configMapKeyRef:
                  key: oidc_issuer
                  name: webpm
            - name: ASSETS_GATEWAY_BASE_URL
              valueFrom:
                configMapKeyRef:
                  key: assets-gatewayBaseUrl
                  name: webpm
            - name: DEFAULT_CDN_CLIENT_VERSION
              valueFrom:
                configMapKeyRef:
                  key: default_cdn_client_version
                  name: webpm

            - name: DEFAULT_WEBPM_CLIENT_VERSION
              valueFrom:
                configMapKeyRef:
                  key: default_webpm_client_version
                  name: webpm

            - name: CLIENT_ID
              valueFrom:
                configMapKeyRef:
                  key: client_id
                  name: webpm
            - name: CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  key: client_secret
                  name: webpm
          image: {{ printf "registry.gitlab.com/youwol/platform/webpm:%s" .Chart.AppVersion }}
          imagePullPolicy: Always
          readinessProbe:
            httpGet:
              port: 8000
              path: /observability/readiness
          livenessProbe:
            httpGet:
              port: 8000
              path: /observability/liveness
          startupProbe:
            httpGet:
              port: 8000
              path: /observability/startup
      restartPolicy: Always
